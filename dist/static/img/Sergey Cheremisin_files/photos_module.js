!function(e){function t(i){if(s[i])return s[i].exports;var o=s[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var s={};return t.m=e,t.c=s,t.d=function(e,s,i){t.o(e,s)||Object.defineProperty(e,s,{configurable:!1,enumerable:!0,get:i})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var s=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=505)}({149:function(e,t,s){"use strict";s.r(t);var i=s(353),o=s(170);window.PhotoTags=i["default"],window.PhotoTooltip=o["default"];try{stManager.done(jsc("web/photos_module.js"))}catch(n){}},170:function(e,t,s){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}s.r(t);var o=s(372),n=280,r="bottom",a="right_top",d=300,h=10,u=function(){function e(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e),this.options=extend({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:function(){return!1},onMouseLeave:function(){return!1},onEscapePressed:function(){return!1},onDeleteClicked:function(){return!1},onSuggestionDeclined:function(){return!1}},s),this.container=t,this.friendsDropdown=new o["default"]({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}return e.prototype.renderTooltip=function(){var e=this;this.tooltipNode=ce("div",{className:"photo_tooltip"},{display:"none"});var t=ce("div",{className:"photo_tooltip__content"});this.sugggestionNode=ce("div"),this.nameNode=ce("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=ce("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),addEvent(this.nameNode,"click",this._handleConfirmedTooltipClick),t.appendChild(this.nameNode),t.appendChild(this.sugggestionNode),t.appendChild(this.listNode),this.tooltipNode.appendChild(t),this.container.appendChild(this.tooltipNode),addEvent(this.tooltipNode,"mouseenter",function(){e.isActive=!0}),addEvent(this.sugggestionNode,"click",function(t){cancelEvent(t);var s=window.domData(t.target,"button");switch(s){case"yes":e.options.onUserSelected(e.suggestedUserId,e.suggestedUserName,!0);break;case"no":e.options.onSuggestionDeclined(),hide(e.sugggestionNode),e.showFriendsList(),e.userHref=null,e.showAndFocusFriendsList()}}),addEvent(this.tooltipNode,"mouseleave",function(){e.interaction||(e.isActive=!1,e.options.onMouseLeave())}),this.options.closeOnClick&&addEvent(document,"click",this._handleDocumentClick)},e.prototype._handleDocumentClick=function(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()},e.prototype._handleUserSelected=function(e,t){this.isActive=!1,this.options.onUserSelected(e,t)},e.prototype._handleEscapePress=function(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()},e.prototype._handleStartInteraction=function(){this.interaction=!0},e.prototype._handleConfirmedTooltipClick=function(e){cancelEvent(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&nav.go(this.userHref,e)},e.prototype.updatePosition=function(e){var t=e.top,s=e.right,i=e.bottom,o=e.left,u=s-o,c=getSize(this.tooltipNode),l=c[0]?c[0]:n,p=r,g=o+Math.floor(u/2)-l/2,v=i;if((h>g||this.hasDropdown&&i>window.clientHeight()-d)&&(p=a),p===a){g=s,v=t;var f=window.clientHeight()-t;d>f&&(v=t-d+f)}domData(this.tooltipNode,"dir",p),setStyle(this.tooltipNode,{top:v,left:g})},e.prototype.updateSuggestionQuestion=function(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e},e.prototype._getSuggestionHTML=function(e,t){var s=e===vk.id?getLang("photos_tags_user_you"):t,i=getLang("photos_tags_suggestion_question").replace("{userName}",'<div class="suggested_tag_user__name">&nbsp;'+s+"</div>");return'<div class="suggested_tag_user">\n      '+i+'\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">'+getLang("box_yes")+'</button>\n        <span>&middot;</span>\n        <button data-button="no">'+getLang("box_no")+"</button>\n      </div>\n    </div>"},e.prototype.updateState=function(e){var t=e.suggestedUserName,s=e.suggestedUserId,i=e.usersList,o=e.userName,n=e.userHref,r=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=n,this.hasDropdown=!1,removeClass(this.tooltipNode,"tagged"),o?(this.nameNode.innerHTML=o+" "+(r?"<button>Delete</button>":""),toggleClass(this.nameNode,"show_delete",r),show(this.nameNode),hide(this.listNode),hide(this.sugggestionNode),addClass(this.tooltipNode,"tagged")):s?(this.updateSuggestionQuestion(s,t),hide(this.nameNode),hide(this.listNode),show(this.sugggestionNode)):(this.friendsDropdown.update(i),hide(this.nameNode),hide(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)},e.prototype.showFriendsList=function(){show(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()},e.prototype.resetFriendsDropdown=function(){this.friendsDropdown.reset()},e.prototype.show=function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),show(this.tooltipNode),s&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}),e.prototype.hide=function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){hide(this.tooltipNode)}),e.prototype.showAndFocusFriendsList=function(){this.userHref?nav.go(this.userHref):(this.friendsDropdown.focus(),this.friendsDropdown.show())},e.prototype.unMount=function(){removeEvent(document,"click",this._handleDocumentClick),re(this.tooltipNode)},e}();t["default"]=u},353:function(e,t,s){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}s.r(t);var o=s(170),n=s(683),r=function(){function e(e,t){var s=[],i=!0,o=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(d){o=!0,n=d}finally{try{!i&&a["return"]&&a["return"]()}finally{if(o)throw n}}return s}return function(t,s){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,s);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=window.getXYRect,d=500,h=700,u="photo_tags_suggested_areas_list",c="photo_tags_suggested_area",l="area_hover",p="visible_all",g=function(){function e(t,s){i(this,e),this.imageNode=t,this.containerNode=s,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this._updatePhotoView=this._updatePhotoView.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}return e.prototype._init=function(){this.photoTooltip=new o["default"](window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined}),this.photoView=window.Photoview,this.areasContainer=ce("div",{className:u}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),addEvent(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),addEvent(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()},e.prototype._handleImageMouseMove=function(e){var t=this;if(!this.areasHidden){var s=getXY(e.target),i=Math.round(100*(e.pageX-s[0])/e.target.offsetWidth),o=Math.round(100*(e.pageY-s[1])/e.target.offsetHeight);clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout(function(){t.photoTooltip.isActive||t.activeAreaId||t.hideAllSuggestedAreas()},h),this.showAllSuggestedAreas();for(var n in this.areas)if(this.areas.hasOwnProperty(n)){var r=this.areas[n],a=r.x,d=r.y,u=r.x2,c=r.y2;if(i>parseInt(a)&&i<parseInt(u)&&o>parseInt(d)&&o<parseInt(c)){if(n===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(n),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}},e.prototype._handleAreaClick=function(e){cancelEvent(e),this.photoTooltip.showAndFocusFriendsList()},e.prototype.showTagArea=function(e){var t=this.areas[e];return!t||t.isDeleted?!1:(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,addClass(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)},e.prototype.hideTagArea=function(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&removeClass(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()},e.prototype._removeActiveAreaAfterTimeout=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d;this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout(function(){var t=!e.photoTooltip.isActive&&!e.tagAreaFound&&!e.photoTooltip.interaction;t&&e.hideTagArea(),e.waitToRemove=!1},t))},e.prototype.showTooltip=function(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,s=this._getTooltipOptions(e);if(t){var i=a(t,!0),o=i.top,n=i.right,r=i.bottom,d=i.left;this.photoTooltip.show({top:o,right:n,bottom:r,left:d},s)}}},e.prototype.showAllSuggestedAreas=function(){addClass(this.areasContainer,p),removeClass(this.areasContainer,l),this.activeAreaId&&addClass(this.areasContainer,l)},e.prototype.hideAllSuggestedAreas=function(){removeClass(this.areasContainer,p)},e.prototype.pauseTooltips=function(){this.hideTagArea(),this.tooltipsPaused=!0},e.prototype.resumeTooltips=function(){this.tooltipsPaused=!1},e.prototype._createTagElement=function(e,t,s,i){var o=cur.pvPhWidth,n=cur.pvPhHeight,r=n/o,a=s-e,d=i-t,h=ce("div",{className:c},{left:e+"%",marginTop:r*t+"%",width:a+"%"}),u=ce("div",{},{paddingBottom:100*r*(d/a)+"%"});return h.appendChild(u),h},e.prototype.renderTagAreas=function(){this.areas={},this.areasContainer.innerHTML="";var e=Object(n.getPhotoData)("tags"),t=Object(n.getPhotoData)("suggested_tags");cur.postTo&&cur.postTo<0&&(t=[]);for(var s in e)if("0"!==s&&e.hasOwnProperty(s)){var i=r(e[s],7),o=i[0],a=i[1],d=i[2],h=i[3],u=i[4],c=i[5],l=i[6],p=this._createTagElement(o,a,d,h);this.areas[s]={ele:p,x:o,y:a,x2:d,y2:h,userName:u,userHref:c,canDeleteTag:Boolean(l),confirmedTag:!1},this.areasContainer.appendChild(p)}for(var g in t)if(g&&t.hasOwnProperty(g)){var v=r(t[g],7),f=v[0],m=v[1],_=v[2],w=v[3],y=v[4],T=v[5],I=v[6],A=this._createTagElement(f,m,_,w),N=void 0;y&&(N="/id"+y),this.areas[g]={ele:A,x:f,y:m,x2:_,y2:w,userHref:N,suggestedUserId:y,suggestedUserName:T,usersList:I,confirmedTag:!1},this.areasContainer.appendChild(A)}},e.prototype._userSelectedCallback=function(e,t){var s=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,o=Object(n.getPhotoData)("tags"),r=Object(n.getPhotoData)("suggested_tags"),a=this.activeAreaId,d=this.areas[a],h=d.x,u=d.y,c=d.x2,l=d.y2,p="/id"+e,g=cur.pvAskForAutoTag&&i,v=clean(t);o[a]=[h,u,c,l,v,p,!0],delete r[a];var f={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:v,userHref:p,canDeleteTag:!0},m=this.activeAreaId;this._confirmSuggestedTag(a,e,t,function(){s.activeAreaId=m,s.areas[m]=extend(d,f),s.photoTooltip.updateState(f),s.showTagArea(m),s._removeActiveAreaAfterTimeout(1e3),g&&(cur.pvAskForAutoTag=!1,s.showSettingsBox())})},e.prototype.showSettingsBox=function(){showBox("/al_photos.php",{act:"show_autotag_settings"},{params:{containerClass:"autotag_settings_box",grey:!0,width:450}})},e.prototype.deleteTag=function(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=extend(t,{isDeleted:!0}),addClass(t.ele,"deleted"))},e.prototype._getTooltipOptions=function(e){var t=this.areas[e],s=t.suggestedUserId,i=t.suggestedUserName,o=t.userName,n=t.userHref,r=t.usersList,a=t.canDeleteTag;return{suggestedUserId:s,userName:o,userHref:n,suggestedUserName:i,usersList:r,canDeleteTag:a}},e.prototype._handleSuggestionDeclined=function(){var e=this.activeAreaId,t=this.areas[e];if(t){var s={suggestedUserId:!1,suggestedUserName:!1,userHref:null},i=Object(n.getPhotoData)("suggested_tags");this.areas[e]=extend(t,s),this.showTagArea(e),i&&i[e]&&(i[e][4]=0);var o=Object(n.getPhotoData)("id"),r=Object(n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:o,hash:r},{onFail:this.handleTagRequestFail})}},e.prototype._confirmSuggestedTag=function(e,t,s,i){var o=this,r=Object(n.getPhotoData)("id"),a=Object(n.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:s,photo:r,hash:a},{onDone:function(e,t,s){o._updatePhotoView(e,t,s),i()},onFail:this.handleTagRequestFail})},e.prototype.handleTagRequestFail=function(e){var t=getLang("global_error");return setTimeout(showFastBox(t,e).hide,3e3),!0},e.prototype.unMount=function(){removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),removeEvent(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""},e.prototype.hideAreas=function(){this.areasHidden=!0,hide(this.areasContainer),this.photoTooltip.hide()},e.prototype.showAreas=function(){this.areasHidden=!1,show(this.areasContainer),removeEvent(this.imageNode,"mousemove",this._handleImageMouseMove),addEvent(this.imageNode,"mousemove",this._handleImageMouseMove)},e.prototype.reload=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()},e.prototype._queueCheckUpdates=function(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)},e.prototype._updatePhotoView=function(e,t,s){Object(n.setPhotoData)("tags",e),Object(n.setPhotoData)("tagged",t),Object(n.setPhotoData)("tagshtml",s),this.photoView.setTags(s)},e.prototype._queueReceiveUpdates=function(e,t){var s=this;t.events&&t.events.forEach(function(e){var t=e.split("<!>"),i=t[1],o=t[2],r=JSON.parse(o),a=JSON.parse(t[3]),d=JSON.parse(t[4]),h=t[5];if(Object(n.getPhotoData)("id")===i)Object(n.setPhotoData)("suggested_tags",r),s._updatePhotoView(a,d,h),s.renderTagAreas();else if(cur.pvData){var u=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach(function(t,s){if(t.id&&t.id===i){var o=cur.pvData[e][s];o.suggested_tags=r,o.tags=a,o.tagged=d,o.tagshtml=h}})}};for(var c in cur.pvData)u(c)}})},e}();t["default"]=g},372:function(e,t,s){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}s.r(t);var o=s(683),n=function(){function e(e,t){var s=[],i=!0,o=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done)&&(s.push(r.value),!t||s.length!==t);i=!0);}catch(d){o=!0,n=d}finally{try{!i&&a["return"]&&a["return"]()}finally{if(o)throw n}}return s}return function(t,s){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,s);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),r="friends_dropdown__list_item",a="friends_dropdown__list_item system_message",d="add_term_tag",h=300,u=20,c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e),this.options=extend({onUserSelected:function(){return!1},onEscapePress:function(){return!1},onKeyUp:function(){return!1}},t),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new vkIndexer([],function(e){var t=n(e,2),s=(t[0],t[1]);return s}),cur.pvServerFriendsIds=[]),this.topUsers=new vkIndexer([],function(e){var t=n(e,2),s=(t[0],t[1]);return s}),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}return e.prototype.init=function(){if(!this.isInited||!this.friendsdListNode){var e=Object(o.getIndexedFriends)();e||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll()}return this.friendsdListNode},e.prototype.update=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this._resetScroll(),this.setTopUsers(e),this._hideDropdown()},e.prototype.setTopUsers=function(e){var t=this;this.topUsers.list.forEach(function(e){t.topUsers.remove(e)}),e.forEach(function(e){t.topUsers.add(e)}),this.topUsers.list=e},e.prototype._hideDropdown=function(){removeClass(this.friendsdListNode,"show-dropdown")},e.prototype._getItemHtml=function(e,t,s,i){return'<div class="'+r+'" data-id="'+e+'" data-name="'+t+'">\n      <img src="'+i+'" alt="'+t+'" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">'+t+" "+(e===vk.id.toString()?"("+getLang("photos_tags_user_you")+")":"")+'</div>\n        <div class="friends_dropdown__list_label">'+s+"</div>\n      </div>\n    </div>"},e.prototype._initElement=function(){var e=this;this.friendsdListNode=ce("div",{className:"friends_dropdown__list"}),this.listInput=ce("input",{className:"friends_dropdown__list_input",placeholder:""+replaceEntities(getLang("photos_tags_dropdown_placeholder"))}),this.listDropdown=ce("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=ce("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML('<div class="'+a+'">'+getLang("box_loading")+"</div>"),addEvent(this.friendsdListNode,"click",cancelEvent),addEvent(this.listDropdown,"click",function(t){e._handleItemSelected(t.target)}),addEvent(this.listDropdown,"mouseover",function(t){if(!e.keyboardNavigation){var s=hasClass(t.target,r)?t.target:gpeByClass(r,t.target);e._setHoverItem(s)}}),addEvent(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),addEvent(this.listInput,"click",function(){e.show()})},e.prototype._handleItemSelected=function(e){var t=hasClass(e,r)?e:gpeByClass(r,e),s=domData(t,"name"),i=domData(t,"id");i&&this.options.onUserSelected(i,s),hasClass(e,d)&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)},e.prototype._getItemEleById=function(e){return window.domQuery1('[data-id="'+e+'"]',this.listDropdown)},e.prototype._setListHTML=function(e){var t=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;t.innerHTML=e},e.prototype._setHoverItem=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,s=domData(e,"id");if(s&&s!==this.hoverItem){if(this.hoverItem){var i=this._getItemEleById(this.hoverItem);removeClass(i,"hover")}this.hoverItem=s,addClass(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}},e.prototype.show=function(e){hasClass(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),addClass(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())},e.prototype._renderFriendsList=function(e){var t=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;e=trim(e);var i=Object(o.getIndexedFriends)();if(i){var n=this._doSearch(e);this._renderFriendsDropdown(e,n,s)}else this._setListHTML('<div class="'+a+'">'+getLang("box_loading")+"</div>");clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout(function(){t.fetchFriendsWithQuery(e)},h))},e.prototype._initScroll=function(){var e=this;browser.safari||stManager.add(["ui_common.css","ui_common.js"],function(){e.scroll=new window.uiScroll(e.listContent,{global:!0})})},e.prototype._handleInputKeyEvent=function(e){if("keyup"===e.type){switch(e.keyCode){case KEY.ENTER:this._handleEnter();break;case KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case KEY.UP:case KEY.DOWN:this._handleArrows(e.keyCode===KEY.DOWN)}},e.prototype._handleArrows=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0,t=void 0,s=void 0;if(this.keyboardNavigation||(this.keyboardNavigation=!0,addEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)t=this._getItemEleById(this.hoverItem),s=e?domNS(t):domPS(t);else{var i=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;s=domFC(i)}s&&this._setHoverItem(s,!0)},e.prototype._handleMouseMoveOnce=function(){this.keyboardNavigation=!1,removeEvent(this.listDropdown,"mousemove",this._handleMouseMoveOnce)},e.prototype._handleEnter=function(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}},e.prototype._doSearch=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=void 0,s=Object(o.getPhotoData)("tagged"),i=Object(o.getIndexedFriends)(),r=void 0,a=void 0,d=void 0;e.length>0?(r=this.topUsers.search(e),a=i.search(e),d=cur.pvServerFriendsIndex.search(e)):(r=this.topUsers.list,a=i.list,d=cur.pvServerFriendsIndex.list),t=r.concat(a,d);var h=[];return t=t.filter(function(e){var t=n(e,1),i=t[0],o=h.indexOf(i)<0&&(!s||!s[i]);return h.push(i),o}),t.length>u&&(t=t.slice(0,u)),t},e.prototype._renderFriendsDropdown=function(e,t){var s=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,o="";if(t.forEach(function(e){var t=n(e,4),i=t[0],r=t[1],a=t[2],d=t[3],h="id"+i;o+=s._getItemHtml(i,r,a,d,h)}),!o&&i){this.freeTerm=e,e=clean(e);var r=getLang("photos_tags_not_found_tag_text").replace("{tagName}",'<span class="'+d+'">'+e+"</span>");o='<div class="'+a+'">'+r+"</div>",this._setListHTML(o)}else o&&(this._setListHTML(o),this.freeTerm=null,this._resetScroll());this.hoverItem=null},e.prototype.focus=function(){this.listInput.focus()},e.prototype.reset=function(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()},e.prototype._resetScroll=function(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0},e.prototype.fetchFriendsList=function(){var e=this;ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:function(t){Object(o.setIndexedFriends)(t,function(){e._renderFriendsList(e.lastSeachTerm)})}})},e.prototype.fetchFriendsWithQuery=function(e){var t=this;ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:Object(o.getPhotoData)("id")},{onDone:function(s){t._handleFetchFriends(e,s)}})},e.prototype._handleFetchFriends=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.lastSeachTerm===e){var s=0,i=void 0,r=Object(o.getPhotoData)("tagged");i=r?t.filter(function(e){var t=n(e,1),s=t[0];return!r[s]}):t,i.forEach(function(e){var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),s++)}),(s>0||0===i.length)&&this._renderFriendsList(e,!0)}},e}();t["default"]=c},505:function(e,t,s){e.exports=s(149)},683:function(e,t,s){"use strict";function i(e){var t=cur.pvListId,s=cur.pvIndex;if(cur.pvData&&t&&!isNaN(s)){var i=cur.pvData[t][s];return e?i[e]:i}return!1}function o(e,t){var s=cur.pvListId,i=cur.pvIndex;return cur.pvData&&s&&!isNaN(i)?(cur.pvData[s][i][e]=t,cur.pvData[s][i]):!1}function n(){return cur.pvIndexedFriends}function r(e,t){cur.pvIndexedFriends=new vkIndexer(e,function(e){return e[1]},t)}s.r(t),s.d(t,"getPhotoData",function(){return i}),s.d(t,"setPhotoData",function(){return o}),s.d(t,"getIndexedFriends",function(){return n}),s.d(t,"setIndexedFriends",function(){return r})}});